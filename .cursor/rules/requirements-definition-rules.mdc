---
alwaysApply: true
---

# 要件定義書（v0.5.1）— 米国株 × moomoo 初期対応
更新日: 2025-08-24（JST）

## 0. 変更要約（v0.5 → v0.5.1）
- **Paper Trading を初回必須**（`trd_env=SIMULATE`、成行/指値・DAY限定、約定ログの不完全性を許容）。Live は最小株数による段階的検証。
- **調整済みヒストリカルの自動補完**：moomoo で未提供のとき **Tiingo → Yahoo Finance** の順で欠損を補完（`SyncHistoricalData` ユースケースを要件化）。
- **税務エクスポートを二系統**：TWS 形式（米国標準）＋ 日本向け「年間取引報告書風」CSV。
- moomoo API 制約（購読上限/レート制限/OCO 擬似/再接続再購読/空売り可否 API）の章を追記・強化。

---

## 1. 目的・スコープ
- 目的: 米国株を対象に、**デイトレ〜スイング（数日〜数週間）**を安定運用できる自動/半自動のシステムトレード基盤を構築する。
- スコープ: 戦略スクリプト（Starlark/DSL）、市場データ取得、バックテスト、リスク/執行、UI/運用を一貫提供。
- 非スコープ: 高頻度取引、アービトラージ、国内FX、日本株。

## 2. 利用者・運用
- 利用者: 管理者 1 アカウント（将来マルチユーザー拡張可能）。
- 運用: 立会時間（America/New_York 09:30–16:00, DST 対応）に自動稼働、JST 夜間に日次集計。Slack/Email 通知を中核。

## 3. 対応市場・銘柄
- 取引対象: 米国個別株/ETF（NASDAQ/NYSE/ARCA 等）。
- ユニバース: 初期 **S&P100**。週次で出来高/価格帯/ボラ条件により自動スクリーニング更新（UI から条件編集）。
- 祝日: 米国市場カレンダー（iCal）で自動停止。**プレ/アフターマーケットは初期非対応**。

## 4. ブローカー/インフラ要件（moomoo / Futu OpenD）
- 接続: Futu OpenD（ローカル/リモート）経由で Push/REST を利用。
- 同時購読上限: 口座条件により **100 / 300 / 1000 / 2000 枠**。**「銘柄×サブタイプ＝1枠」**。同一銘柄の K 線は TF 複数でも **1枠**。例: AAPL の Tick + K 線 = **2枠**。
- レート制限: エンドポイント毎に上限あり（例: Snapshot 30 秒/60 回 等）。Push は頻度制約なし。
- 注文種別: **Market/Limit/Stop/Stop-Limit/Trailing**。**OCO はネイティブ無し** → **擬似 OCO**（相互キャンセル）をサーバ側で実装。
- Paper Trading: **必須**（成行/指値・DAY 限定、約定一覧 API 無し、スリッページ再現なし）。
- 空売り: 銘柄ごとに **可否/在庫/金利 API** を参照（ショート不可銘柄を自動除外）。
- 再接続: OpenD 側復旧時は Tick 最大 50 件補完。アプリ側断復旧時は **再購読（subscribe_push=true）** を必須。

## 5. 機能要件
### 5.1 データ
- 足: 1m/5m/15m/1d（UTC 内部保持）。
- 調整: **調整済み（Split/配当）を標準**。未提供時は **Tiingo → Yahoo** で自動補完。補完ソースは監査ログに記録。
- 保存: 直近 30 日は MySQL、以降は Object Storage（gzip/zstd）へアーカイブ（90 日→低頻度、365 日→アーカイブ層）。

### 5.2 戦略（テンプレート）
- 共通: Starlark で記述、UI からパラメータ編集。イベント: `on_bar`, `on_order_fill`。
1) **EMA クロス**（例: EMA9/EMA21 + ATR/出来高フィルタ）  
2) **RSI リバーサル**（RSI 反発/反落 + BB/乖離/最大保有バー）  
3) **ブレイクアウト**（N 日高値/安値ブレイク + ATR ベース SL/TP）  
4) **一目均衡表**（雲抜け/転換×基準/遅行スパン/雲厚み）  
- エグジット: 時間経過/反対シグナル/ATR トレール/SL・TP 到達。

### 5.3 リスク・執行
- 1トレード損失上限: 初期 0.25%（ATR 幅から株数算出）。
- 日次/週次 DD: 初期 1% / 3%（閾値超過で新規停止、既存は保持）。
- 同時ポジション上限: 同銘柄 1（初期）。
- 冪等性: `client_order_id` 必須。重複は **200 OK（既存返却）**。payload 不一致は **409**。
- 再試行: 最大 3 回/合計 10 秒（指数バックオフ）。
- サーキット: 連続失敗 5 / 未約定 10 / スプレッド超過で新規 OFF + 通知。
- **擬似 OCO**: 片方 SUBMITTED/（PARTIAL）FILLED で相互キャンセルを自動発行。

### 5.4 バックテスト/検証
- CLI/HTTP 両対応（本番 VM と同 API 面）。
- 入力: CSV (`ts,open,high,low,close,volume` UTC) / JSON。  
- 出力: PF/Sharpe/MaxDD/勝率/SQN/CAGR、equity_curve、by_month。
- **スリッページモデル**: 固定値 + 動的（ATR/出来高）。
- **Paper → Live ゲート（必須）**  
  - 連続 20 取引以上、日次 DD ≤ 1%、週次 DD ≤ 3%、PF ≥ 1.2。  
  - 通過後も **Live は最小株数**で段階的に検証。

### 5.5 UI/運用
- **フロントエンド**: Next.js + shadcn/ui + zod（バリデーション）+ zustand（状態管理）
- 戦略センター（テンプレ選択→編集→BT→Paper→Live）。
- モニタ（PnL、DD、勝率、戦略ログ、サーキット通知履歴）。
- **Kill スイッチ**：未約定キャンセル＋全ポジ成行クローズ＋Runner 停止。二重確認。
- **エンドポイントテスト**: Bruno（日本語フォルダ構成、エンドポイント毎に.brunoファイル）

### 5.6 税務エクスポート
- **TWS 形式**：`trade_id,symbol,open_time,close_time,side,quantity,open_price,close_price,realized_pnl,commission,dividend,tax_withheld,currency,strategy_id`。
- **日本向け「年間取引報告書風」**：`約定日,銘柄,取引区分,数量,単価,受渡金額,手数料,税金,実現損益,通貨,戦略ID` 等（テンプレ提供、証券各社差は備考列）。

## 6. 非機能要件
- 可用性 99.5%/月。
- セキュリティ: API キーは AES‑GCM で暗号化（OCI Vault）、2FA 必須。
- 監査: 1 トレード ID に対し「入力→シグナル→注文→約定」を鎖状トレース（可視化）。
- コスト: 初期 S&P100 で概算 ¥79/月。S&P500 拡張でも ¥600 程度、上限 ¥10,000/月。

## 7. 制約・前提
- moomoo/Futu API の約款・規制に従い自動化を行う（免責を UI/ToS に明記）。
- 空売り/括りの可否は口座・銘柄に依存（UI 表示で制御）。
- 調整データの差異は BT 結果に注記。

## 8. 受け入れ基準（要約）
- Paper 必須のワークフローが UI/API で強制されること。
- 欠損ヒストリカルが自動補完されること（監査にソース記録）。
- 税務 CSV（TWS/日本向け）が任意期間で出力できること。

---
