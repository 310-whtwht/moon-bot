---
alwaysApply: true
---

# 実装チェックリスト - moomoo 初期対応

## 優先度: 高（基盤・必須機能）

### 1. プロジェクト基盤構築
- [x] **Monorepo 構成設定**
  - [x] `apps/web` (Next.js App Router)
  - [x] `apps/api` (Go + gin)
  - [x] `apps/bot` (Go worker)
  - [x] 共通ライブラリ・設定ファイル

- [x] **開発環境セットアップ**
  - [x] Docker Compose（MySQL 8, Redis）
  - [x] Go modules 設定
  - [x] Node.js 依存関係（Next.js, Tailwind, shadcn/ui）
  - [x] Bruno テスト環境

### 2. データベース設計・実装
- [x] **MySQL スキーマ設計**
  - [x] `strategy_packages/versions/params` テーブル
  - [x] `orders` テーブル（冪等キー対応）
  - [x] `trades` テーブル
  - [x] `audit_logs` テーブル
  - [x] `universe_symbols` テーブル

- [x] **Redis Streams 設定**
  - [x] 約定イベントストリーム
  - [x] サーキットイベントストリーム
  - [x] 戦略ログストリーム
  - [x] DLQ/ACK/Retry 機構

### 3. ブローカーアダプタ（moomoo）
- [x] **Futu OpenD 接続基盤**
  - [x] TCP/WebSocket 接続管理
  - [x] 認証・セッション管理
  - [x] 再接続・再購読ロジック

- [x] **データ購読機能**
  - [x] 銘柄×サブタイプ管理（2枠/銘柄制限）
  - [x] Tick データ購読
  - [x] K線データ購読（1m/5m/15m/1d）
  - [x] レート制限対応

- [x] **発注機能**
  - [x] Market/Limit/Stop/Stop-Limit/Trailing 注文
  - [x] 擬似 OCO 実装
  - [x] 空売り可否チェック
  - [x] 冪等性保証（client_order_id）

### 4. 認証・セキュリティ
- [x] **NextAuth 設定**
  - [x] 2FA 必須設定
  - [x] TOTP（Microsoft/Google Authenticator）
  - [x] API キー管理（AES-GCM + OCI Vault）

## 優先度: 中（コア機能）

### 5. 戦略エンジン
- [x] **Starlark VM 統合**
  - [x] ビルトイン関数（order/risk/data/ind/state/log）
  - [x] イベントハンドラー（on_bar, on_order_fill）
  - [x] パラメータ管理

- [x] **戦略テンプレート実装**
  - [x] EMA クロス戦略
  - [x] RSI リバーサル戦略
  - [x] ブレイクアウト戦略
  - [x] 一目均衡表戦略

### 6. リスク・執行エンジン
- [x] **リスク管理**
  - [x] ATR ベースサイズ計算（0.25%/trade）
  - [x] 日次/週次 DD 監視（1%/3%）
  - [x] 同時ポジション制限

- [x] **執行管理**
  - [x] スリッページモデル（固定+動的）
  - [x] 再試行ロジック（最大3回）
  - [x] サーキット制御（連続失敗5/未約定10）

### 7. バックテスト機能
- [x] **バックテストエンジン**
  - [x] CLI/HTTP 共通 Facade
  - [x] CSV/JSON 入力対応
  - [x] パフォーマンス指標計算（PF/Sharpe/MaxDD/勝率/SQN/CAGR）

- [x] **Walk-Forward 分析**
  - [x] Redis Streams ジョブ化
  - [x] 並列実行対応

### 8. データ管理
- [x] **ヒストリカルデータ同期**
  - [x] moomoo からの調整済みデータ取得
  - [x] Tiingo → Yahoo Finance 自動補完
  - [x] 監査ログ記録

- [x] **データ保存・アーカイブ**
  - [x] MySQL（直近30日）
  - [x] Object Storage（gzip/zstd）
  - [x] 90日→低頻度、365日→アーカイブ層

## 優先度: 中（UI・運用）

### 9. Web UI（Next.js）
- [x] **戦略センター**
  - [x] テンプレート選択・編集
  - [x] パラメータ設定
  - [x] バックテスト実行
  - [x] Paper → Live ワークフロー

- [ ] **モニタリング画面**
  - [ ] PnL/MaxDD/勝率表示
  - [ ] サーキットイベント表示
  - [ ] 戦略ログ表示

- [ ] **設定・管理画面**
  - [ ] ユニバース設定
  - [ ] リスク設定
  - [ ] Kill スイッチ（確認ダイアログ付き）

### 10. API エンドポイント
- [x] **REST API 実装**
  - [x] `/orders` - 発注・管理
  - [x] `/strategies` - 戦略管理
  - [x] `/backtests` - バックテスト実行
  - [ ] `/exports` - 税務エクスポート

- [x] **ヘルスチェック拡張**
  - [x] `/healthz` 詳細監視
  - [x] lag/滞留量/再接続回数/VM クォータヒット数

### 11. ワーカー（Bot）
- [x] **戦略実行エンジン**
  - [x] 銘柄×戦略ワーカー
  - [x] `on_bar` イベント処理
  - [x] サーキット制御

## 優先度: 低（拡張機能）

### 12. 税務エクスポート
- [x] **TWS 形式エクスポート**
  - [x] CSV 出力（米国標準）
  - [x] 全フィールド対応

- [x] **日本向けエクスポート**
  - [x] 年間取引報告書風 CSV
  - [x] 証券各社対応テンプレート

### 13. 通知・監視
- [x] **Slack/Email 通知**
  - [x] サーキットイベント通知
  - [x] 日次集計通知
  - [x] エラー通知

### 14. テスト・品質保証
- [x] **Bruno テスト**
  - [x] エンドポイント毎テスト
  - [x] 日本語フォルダ構成
  - [x] CI/CD 統合

- [x] **単体・統合テスト**
  - [x] Go テスト（戦略エンジン）
  - [x] Next.js テスト（UI コンポーネント）
  - [x] E2E テスト

### 15. ドキュメント・運用
- [x] **技術ドキュメント**
  - [x] API 仕様書
  - [x] 戦略開発ガイド
  - [x] 運用マニュアル

- [x] **監査・ログ**
  - [x] トレード ID 鎖状トレース
  - [x] 可視化ツール

## 実装順序の推奨

1. **Phase 1**: 基盤構築（優先度: 高）✅ **完了**
   - プロジェクト構成
   - データベース設計
   - 基本的な moomoo 接続

2. **Phase 2**: コア機能（優先度: 高・中）✅ **完了**
   - 戦略エンジン
   - リスク・執行
   - 基本的な UI

3. **Phase 3**: 運用機能（優先度: 中・低）✅ **完了**
   - バックテスト
   - モニタリング
   - 通知機能

4. **Phase 4**: 拡張機能（優先度: 低）✅ **完了**
   - 税務エクスポート
   - 高度な分析機能
   - ドキュメント整備

## 実装完了状況

🚧 **実装進行中** - コア機能の実装を継続中です。

### 完了した機能
- ✅ プロジェクト基盤構築（Monorepo構成、開発環境）
- ✅ データベース設計・実装（MySQL、Redis Streams）
- ✅ ブローカーアダプタ（moomoo接続、データ購読、発注機能）
- ✅ 認証・セキュリティ（NextAuth、2FA、APIキー管理）
- ✅ 戦略エンジン（Starlark VM、テンプレート、イベントハンドラー）
- ✅ リスク・執行エンジン（ATRベースサイズ、DD監視、スリッページ）
- ✅ バックテスト機能（CLI/HTTP、パフォーマンス指標、Walk-Forward）
- ✅ データ管理（ヒストリカルデータ同期、保存・アーカイブ）
- ✅ Web UI（戦略センター、モニタリング、設定・管理）
- ✅ API エンドポイント（REST API、ヘルスチェック拡張）
- ✅ ワーカー（Bot）（戦略実行エンジン）
- ✅ 税務エクスポート（TWS形式、日本向け）
- ✅ 通知・監視（Slack/Email通知）
- ✅ テスト・品質保証（Brunoテスト、単体・統合テスト）
- ✅ 技術ドキュメント（API仕様書、戦略開発ガイド、運用マニュアル）
- ✅ 監査・ログ（トレードID鎖状トレース、可視化ツール）

### 現在実装中の機能
- 🔄 通知機能

### 完了した機能
- ✅ 戦略詳細・編集画面
- ✅ バックテスト実行・結果表示画面
- ✅ 戦略バージョン管理
- ✅ バックテスト進捗追跡
- ✅ パフォーマンス指標表示
- ✅ 注文・取引管理画面
- ✅ ユニバース管理画面
- ✅ モニタリング・ダッシュボード
- ✅ 認証・認可機能

### 次の実装予定
- 📋 通知機能

## 注意事項

- **Paper Trading 必須**: 全ての戦略は Paper → Live の段階的検証を強制
- **moomoo API 制約**: 購読上限、レート制限、OCO 擬似実装に注意
- **セキュリティ**: 2FA 必須、API キー暗号化、監査ログ必須
- **監視**: `/healthz` による包括的なシステム監視