---
alwaysApply: true
---

# é‹ç”¨ãƒ»ç›£è¦–æ‰‹é †ä»•æ§˜

## 1. æ—¥å¸¸é‹ç”¨

### 1.1 ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–
```bash
# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl -f https://api.trading-system.com/healthz

# ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèª
curl https://api.trading-system.com/metrics

# ãƒ­ã‚°ç¢ºèª
kubectl logs -n trading-system deployment/trading-api --tail=100
kubectl logs -n trading-system deployment/trading-bot --tail=100
```

### 1.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›£è¦–
```sql
-- æ¥ç¶šæ•°ç¢ºèª
SHOW PROCESSLIST;

-- ã‚¹ãƒ­ãƒ¼ã‚¯ã‚¨ãƒªç¢ºèª
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;

-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚µã‚¤ã‚ºç¢ºèª
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'
FROM information_schema.tables 
WHERE table_schema = 'trading_system'
ORDER BY (data_length + index_length) DESC;
```

### 1.3 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
```bash
# CPUä½¿ç”¨ç‡ç¢ºèª
kubectl top pods -n trading-system

# ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ç¢ºèª
kubectl top pods -n trading-system --containers

# ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ç¢ºèª
kubectl exec -n trading-system deployment/mysql -- df -h
```

## 2. éšœå®³å¯¾å¿œ

### 2.1 éšœå®³æ¤œçŸ¥
```yaml
# monitoring/alerts/incident-detection.yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: incident-detection
  namespace: monitoring
spec:
  groups:
  - name: incident
    rules:
    - alert: APIDown
      expr: up{job="trading-api"} == 0
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "API is down"
        description: "Trading API has been down for more than 1 minute"
        
    - alert: HighErrorRate
      expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "High error rate detected"
        description: "Error rate is {{ $value | humanizePercentage }}"
        
    - alert: DatabaseConnectionFailed
      expr: mysql_up == 0
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "Database connection failed"
        description: "MySQL database is not responding"
```

### 2.2 éšœå®³å¯¾å¿œæ‰‹é †
```bash
#!/bin/bash
# scripts/incident-response.sh

set -e

INCIDENT_TYPE=$1
SEVERITY=$2

echo "Starting incident response for $INCIDENT_TYPE (Severity: $SEVERITY)"

case $INCIDENT_TYPE in
    "api_down")
        echo "1. Checking API status..."
        kubectl get pods -n trading-system -l app=trading-api
        
        echo "2. Checking logs..."
        kubectl logs -n trading-system deployment/trading-api --tail=50
        
        echo "3. Restarting API deployment..."
        kubectl rollout restart deployment/trading-api -n trading-system
        
        echo "4. Monitoring restart..."
        kubectl rollout status deployment/trading-api -n trading-system
        ;;
        
    "database_down")
        echo "1. Checking database status..."
        kubectl get pods -n trading-system -l app=mysql
        
        echo "2. Checking database logs..."
        kubectl logs -n trading-system deployment/mysql --tail=50
        
        echo "3. Checking database connectivity..."
        kubectl exec -n trading-system deployment/mysql -- mysqladmin ping
        
        echo "4. Restarting database if needed..."
        kubectl rollout restart deployment/mysql -n trading-system
        ;;
        
    "high_error_rate")
        echo "1. Checking error logs..."
        kubectl logs -n trading-system deployment/trading-api --tail=100 | grep ERROR
        
        echo "2. Checking system resources..."
        kubectl top pods -n trading-system
        
        echo "3. Scaling up if needed..."
        kubectl scale deployment trading-api -n trading-system --replicas=5
        ;;
        
    *)
        echo "Unknown incident type: $INCIDENT_TYPE"
        exit 1
        ;;
esac

echo "Incident response completed"
```

## 3. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©æ—§

### 3.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
```bash
#!/bin/bash
# scripts/backup-database.sh

set -e

BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/full_backup_$DATE.sql"

echo "Starting database backup..."

# ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
mysqldump \
    --single-transaction \
    --routines \
    --triggers \
    --all-databases \
    --result-file="$BACKUP_FILE"

# åœ§ç¸®
gzip "$BACKUP_FILE"

# å¤ã„ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤ï¼ˆ30æ—¥ä»¥ä¸Šï¼‰
find "$BACKUP_DIR" -name "*.sql.gz" -mtime +30 -delete

echo "Backup completed: $BACKUP_FILE.gz"
```

### 3.2 å¾©æ—§æ‰‹é †
```bash
#!/bin/bash
# scripts/restore-database.sh

set -e

BACKUP_FILE=$1

if [ -z "$BACKUP_FILE" ]; then
    echo "Usage: $0 <backup_file>"
    exit 1
fi

echo "Starting database restore from $BACKUP_FILE..."

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åœæ­¢
kubectl scale deployment trading-api -n trading-system --replicas=0
kubectl scale deployment trading-bot -n trading-system --replicas=0

# å¾©æ—§å®Ÿè¡Œ
gunzip -c "$BACKUP_FILE" | mysql

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•
kubectl scale deployment trading-api -n trading-system --replicas=3
kubectl scale deployment trading-bot -n trading-system --replicas=2

echo "Database restore completed"
```

## 4. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

### 4.1 æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
```bash
#!/bin/bash
# scripts/deploy-production.sh

set -e

VERSION=$1

if [ -z "$VERSION" ]; then
    echo "Usage: $0 <version>"
    exit 1
fi

echo "Deploying version $VERSION to production..."

# 1. äº‹å‰ãƒã‚§ãƒƒã‚¯
echo "1. Running pre-deployment checks..."
kubectl get pods -n trading-system
kubectl get services -n trading-system

# 2. ã‚¤ãƒ¡ãƒ¼ã‚¸æ›´æ–°
echo "2. Updating images..."
kubectl set image deployment/trading-api api=trading-system/api:$VERSION -n trading-system
kubectl set image deployment/trading-bot bot=trading-system/bot:$VERSION -n trading-system
kubectl set image deployment/trading-web web=trading-system/web:$VERSION -n trading-system

# 3. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆç›£è¦–
echo "3. Monitoring deployment..."
kubectl rollout status deployment/trading-api -n trading-system
kubectl rollout status deployment/trading-bot -n trading-system
kubectl rollout status deployment/trading-web -n trading-system

# 4. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
echo "4. Running health checks..."
for i in {1..10}; do
    if curl -f https://api.trading-system.com/healthz; then
        echo "Health check passed"
        break
    else
        echo "Health check failed, retrying..."
        sleep 10
    fi
done

# 5. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æº–å‚™
echo "5. Setting up rollback..."
kubectl rollout history deployment/trading-api -n trading-system

echo "Deployment completed successfully"
```

### 4.2 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †
```bash
#!/bin/bash
# scripts/rollback.sh

set -e

REVISION=$1

if [ -z "$REVISION" ]; then
    echo "Usage: $0 <revision>"
    exit 1
fi

echo "Rolling back to revision $REVISION..."

# ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
kubectl rollout undo deployment/trading-api -n trading-system --to-revision=$REVISION
kubectl rollout undo deployment/trading-bot -n trading-system --to-revision=$REVISION
kubectl rollout undo deployment/trading-web -n trading-system --to-revision=$REVISION

# ç›£è¦–
kubectl rollout status deployment/trading-api -n trading-system
kubectl rollout status deployment/trading-bot -n trading-system
kubectl rollout status deployment/trading-web -n trading-system

echo "Rollback completed"
```

## 5. ãƒ­ã‚°ç®¡ç†

### 5.1 ãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
```yaml
# config/logging/fluentd-config.yaml
<source>
  @type tail
  path /var/log/containers/*.log
  pos_file /var/log/fluentd-containers.log.pos
  tag kubernetes.*
  read_from_head true
  <parse>
    @type json
    time_format %Y-%m-%dT%H:%M:%S.%NZ
  </parse>
</source>

<filter kubernetes.**>
  @type record_transformer
  enable_ruby true
  <record>
    @timestamp ${time.strftime('%Y-%m-%dT%H:%M:%S.%NZ')}
    level ${record['level'] || 'info'}
    message ${record['message'] || record['log']}
  </record>
</filter>

<match kubernetes.**>
  @type elasticsearch
  host elasticsearch-service
  port 9200
  logstash_format true
  logstash_prefix k8s
  <buffer>
    @type file
    path /var/log/fluentd-buffers/kubernetes.system.buffer
    flush_mode interval
    retry_type exponential_backoff
    flush_interval 5s
    retry_forever false
    retry_max_interval 30
    chunk_limit_size 2M
    queue_limit_length 8
    overflow_action block
  </buffer>
</match>
```

### 5.2 ãƒ­ã‚°åˆ†æ
```bash
# ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°æ¤œç´¢
kubectl logs -n trading-system deployment/trading-api | grep ERROR

# ç‰¹å®šæ™‚é–“ã®ãƒ­ã‚°
kubectl logs -n trading-system deployment/trading-api --since=1h

# ãƒ­ã‚°çµ±è¨ˆ
kubectl logs -n trading-system deployment/trading-api | grep -c ERROR
```

## 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–

### 6.1 ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
```yaml
# monitoring/prometheus/rules/performance.yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: performance-alerts
  namespace: monitoring
spec:
  groups:
  - name: performance
    rules:
    - alert: HighResponseTime
      expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1.0
      for: 3m
      labels:
        severity: warning
      annotations:
        summary: "High response time detected"
        description: "95th percentile response time is {{ $value }}s"
        
    - alert: HighMemoryUsage
      expr: (container_memory_usage_bytes{container="api"} / container_spec_memory_limit_bytes{container="api"}) > 0.8
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High memory usage"
        description: "Memory usage is {{ $value | humanizePercentage }}"
        
    - alert: HighCPUUsage
      expr: (rate(container_cpu_usage_seconds_total{container="api"}[5m]) / container_spec_cpu_quota{container="api"}) > 0.8
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High CPU usage"
        description: "CPU usage is {{ $value | humanizePercentage }}"
```

### 6.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
```bash
# ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“åˆ†æ
curl -s https://api.trading-system.com/metrics | grep http_request_duration_seconds

# ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆç¢ºèª
curl -s https://api.trading-system.com/metrics | grep http_requests_total

# ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨ç‡
kubectl top pods -n trading-system --containers
```

## 7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–

### 7.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ
```yaml
# monitoring/prometheus/rules/security.yaml
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: security-alerts
  namespace: monitoring
spec:
  groups:
  - name: security
    rules:
    - alert: FailedLoginAttempts
      expr: rate(login_attempts_total{status="failed"}[5m]) > 10
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "High number of failed login attempts"
        description: "{{ $value }} failed login attempts per second"
        
    - alert: UnauthorizedAccess
      expr: rate(http_requests_total{status="401"}[5m]) > 5
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "High number of unauthorized access attempts"
        description: "{{ $value }} unauthorized requests per second"
        
    - alert: SuspiciousActivity
      expr: rate(http_requests_total{status="403"}[5m]) > 3
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "Suspicious activity detected"
        description: "{{ $value }} forbidden requests per second"
```

### 7.2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
```bash
# èªè¨¼ãƒ­ã‚°ç¢ºèª
kubectl logs -n trading-system deployment/trading-api | grep "authentication"

# ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°åˆ†æ
kubectl logs -n trading-system deployment/trading-api | grep "access"

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆç¢ºèª
kubectl logs -n trading-system deployment/trading-api | grep "security"
```

## 8. å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

### 8.1 æ—¥æ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
```bash
#!/bin/bash
# scripts/daily-maintenance.sh

set -e

echo "Starting daily maintenance..."

# 1. ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
echo "1. Checking system status..."
kubectl get pods -n trading-system
kubectl get services -n trading-system

# 2. ãƒ­ã‚°ç¢ºèª
echo "2. Checking logs..."
kubectl logs -n trading-system deployment/trading-api --since=24h | grep ERROR | wc -l

# 3. ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨ç‡ç¢ºèª
echo "3. Checking resource usage..."
kubectl top pods -n trading-system

# 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
echo "4. Database maintenance..."
kubectl exec -n trading-system deployment/mysql -- mysql -e "OPTIMIZE TABLE strategies, orders, trades;"

# 5. å¤ã„ãƒ­ã‚°å‰Šé™¤
echo "5. Cleaning old logs..."
find /var/log -name "*.log" -mtime +7 -delete

echo "Daily maintenance completed"
```

### 8.2 é€±æ¬¡ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
```bash
#!/bin/bash
# scripts/weekly-maintenance.sh

set -e

echo "Starting weekly maintenance..."

# 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç¢ºèª
echo "1. Checking security updates..."
kubectl get pods -n trading-system -o jsonpath='{.items[*].spec.containers[*].image}' | tr ' ' '\n' | sort | uniq

# 2. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèª
echo "2. Verifying backups..."
ls -la /backup/mysql/ | tail -5

# 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
echo "3. Performance analysis..."
curl -s https://api.trading-system.com/metrics | grep -E "(http_request_duration_seconds|http_requests_total)"

# 4. ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ç¢ºèª
echo "4. Checking disk usage..."
kubectl exec -n trading-system deployment/mysql -- df -h

# 5. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
echo "5. Verifying configuration..."
kubectl get configmaps -n trading-system
kubectl get secrets -n trading-system

echo "Weekly maintenance completed"
```

## 9. ç·Šæ€¥æ™‚å¯¾å¿œ

### 9.1 ç·Šæ€¥æ™‚é€£çµ¡å…ˆ
```yaml
# config/emergency-contacts.yaml
emergency_contacts:
  primary:
    name: "System Administrator"
    email: "admin@trading-system.com"
    phone: "+81-90-1234-5678"
    slack: "@admin"
  
  secondary:
    name: "Backup Administrator"
    email: "backup-admin@trading-system.com"
    phone: "+81-90-8765-4321"
    slack: "@backup-admin"
  
  escalation:
    name: "CTO"
    email: "cto@trading-system.com"
    phone: "+81-90-1111-2222"
    slack: "@cto"
```

### 9.2 ç·Šæ€¥æ™‚æ‰‹é †
```bash
#!/bin/bash
# scripts/emergency-response.sh

set -e

EMERGENCY_TYPE=$1

echo "EMERGENCY: $EMERGENCY_TYPE detected at $(date)"

case $EMERGENCY_TYPE in
    "system_down")
        echo "1. Notifying emergency contacts..."
        # Slacké€šçŸ¥
        curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ğŸš¨ SYSTEM DOWN: Trading system is completely down"}' \
            $SLACK_WEBHOOK_URL
        
        echo "2. Stopping all trading activities..."
        kubectl scale deployment trading-bot -n trading-system --replicas=0
        
        echo "3. Initiating emergency recovery..."
        kubectl rollout restart deployment/trading-api -n trading-system
        kubectl rollout restart deployment/trading-bot -n trading-system
        ;;
        
    "data_breach")
        echo "1. Immediate system lockdown..."
        kubectl scale deployment trading-api -n trading-system --replicas=0
        kubectl scale deployment trading-bot -n trading-system --replicas=0
        
        echo "2. Notifying security team..."
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒ¼ãƒ é€šçŸ¥
        
        echo "3. Preserving evidence..."
        # ãƒ­ã‚°ä¿å­˜
        ;;
        
    "financial_loss")
        echo "1. Stopping all trading..."
        kubectl scale deployment trading-bot -n trading-system --replicas=0
        
        echo "2. Notifying management..."
        # çµŒå–¶é™£é€šçŸ¥
        
        echo "3. Preserving trading records..."
        # å–å¼•è¨˜éŒ²ä¿å­˜
        ;;
        
    *)
        echo "Unknown emergency type: $EMERGENCY_TYPE"
        exit 1
        ;;
esac

echo "Emergency response initiated"
```