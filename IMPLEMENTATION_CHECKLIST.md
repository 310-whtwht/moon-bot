# 実装チェックリスト - moomoo 初期対応

## 優先度: 高（基盤・必須機能）

### 1. プロジェクト基盤構築
- [ ] **Monorepo 構成設定**
  - [ ] `apps/web` (Next.js App Router)
  - [ ] `apps/api` (Go + gin)
  - [ ] `apps/bot` (Go worker)
  - [ ] 共通ライブラリ・設定ファイル

- [ ] **開発環境セットアップ**
  - [ ] Docker Compose（MySQL 8, Redis）
  - [ ] Go modules 設定
  - [ ] Node.js 依存関係（Next.js, Tailwind, shadcn/ui）
  - [ ] Bruno テスト環境

### 2. データベース設計・実装
- [ ] **MySQL スキーマ設計**
  - [ ] `strategy_packages/versions/params` テーブル
  - [ ] `orders` テーブル（冪等キー対応）
  - [ ] `trades` テーブル
  - [ ] `audit_logs` テーブル
  - [ ] `universe_symbols` テーブル

- [ ] **Redis Streams 設定**
  - [ ] 約定イベントストリーム
  - [ ] サーキットイベントストリーム
  - [ ] 戦略ログストリーム
  - [ ] DLQ/ACK/Retry 機構

### 3. ブローカーアダプタ（moomoo）
- [ ] **Futu OpenD 接続基盤**
  - [ ] TCP/WebSocket 接続管理
  - [ ] 認証・セッション管理
  - [ ] 再接続・再購読ロジック

- [ ] **データ購読機能**
  - [ ] 銘柄×サブタイプ管理（2枠/銘柄制限）
  - [ ] Tick データ購読
  - [ ] K線データ購読（1m/5m/15m/1d）
  - [ ] レート制限対応

- [ ] **発注機能**
  - [ ] Market/Limit/Stop/Stop-Limit/Trailing 注文
  - [ ] 擬似 OCO 実装
  - [ ] 空売り可否チェック
  - [ ] 冪等性保証（client_order_id）

### 4. 認証・セキュリティ
- [ ] **NextAuth 設定**
  - [ ] 2FA 必須設定
  - [ ] TOTP（Microsoft/Google Authenticator）
  - [ ] API キー管理（AES-GCM + OCI Vault）

## 優先度: 中（コア機能）

### 5. 戦略エンジン
- [ ] **Starlark VM 統合**
  - [ ] ビルトイン関数（order/risk/data/ind/state/log）
  - [ ] イベントハンドラー（on_bar, on_order_fill）
  - [ ] パラメータ管理

- [ ] **戦略テンプレート実装**
  - [ ] EMA クロス戦略
  - [ ] RSI リバーサル戦略
  - [ ] ブレイクアウト戦略
  - [ ] 一目均衡表戦略

### 6. リスク・執行エンジン
- [ ] **リスク管理**
  - [ ] ATR ベースサイズ計算（0.25%/trade）
  - [ ] 日次/週次 DD 監視（1%/3%）
  - [ ] 同時ポジション制限

- [ ] **執行管理**
  - [ ] スリッページモデル（固定+動的）
  - [ ] 再試行ロジック（最大3回）
  - [ ] サーキット制御（連続失敗5/未約定10）

### 7. バックテスト機能
- [ ] **バックテストエンジン**
  - [ ] CLI/HTTP 共通 Facade
  - [ ] CSV/JSON 入力対応
  - [ ] パフォーマンス指標計算（PF/Sharpe/MaxDD/勝率/SQN/CAGR）

- [ ] **Walk-Forward 分析**
  - [ ] Redis Streams ジョブ化
  - [ ] 並列実行対応

### 8. データ管理
- [ ] **ヒストリカルデータ同期**
  - [ ] moomoo からの調整済みデータ取得
  - [ ] Tiingo → Yahoo Finance 自動補完
  - [ ] 監査ログ記録

- [ ] **データ保存・アーカイブ**
  - [ ] MySQL（直近30日）
  - [ ] Object Storage（gzip/zstd）
  - [ ] 90日→低頻度、365日→アーカイブ層

## 優先度: 中（UI・運用）

### 9. Web UI（Next.js）
- [ ] **戦略センター**
  - [ ] テンプレート選択・編集
  - [ ] パラメータ設定
  - [ ] バックテスト実行
  - [ ] Paper → Live ワークフロー

- [ ] **モニタリング画面**
  - [ ] PnL/MaxDD/勝率表示
  - [ ] サーキットイベント表示
  - [ ] 戦略ログ表示

- [ ] **設定・管理画面**
  - [ ] ユニバース設定
  - [ ] リスク設定
  - [ ] Kill スイッチ（確認ダイアログ付き）

### 10. API エンドポイント
- [ ] **REST API 実装**
  - [ ] `/orders` - 発注・管理
  - [ ] `/strategies` - 戦略管理
  - [ ] `/backtests` - バックテスト実行
  - [ ] `/exports` - 税務エクスポート

- [ ] **ヘルスチェック拡張**
  - [ ] `/healthz` 詳細監視
  - [ ] lag/滞留量/再接続回数/VM クォータヒット数

### 11. ワーカー（Bot）
- [ ] **戦略実行エンジン**
  - [ ] 銘柄×戦略ワーカー
  - [ ] `on_bar` イベント処理
  - [ ] サーキット制御

## 優先度: 低（拡張機能）

### 12. 税務エクスポート
- [ ] **TWS 形式エクスポート**
  - [ ] CSV 出力（米国標準）
  - [ ] 全フィールド対応

- [ ] **日本向けエクスポート**
  - [ ] 年間取引報告書風 CSV
  - [ ] 証券各社対応テンプレート

### 13. 通知・監視
- [ ] **Slack/Email 通知**
  - [ ] サーキットイベント通知
  - [ ] 日次集計通知
  - [ ] エラー通知

### 14. テスト・品質保証
- [ ] **Bruno テスト**
  - [ ] エンドポイント毎テスト
  - [ ] 日本語フォルダ構成
  - [ ] CI/CD 統合

- [ ] **単体・統合テスト**
  - [ ] Go テスト（戦略エンジン）
  - [ ] Next.js テスト（UI コンポーネント）
  - [ ] E2E テスト

### 15. ドキュメント・運用
- [ ] **技術ドキュメント**
  - [ ] API 仕様書
  - [ ] 戦略開発ガイド
  - [ ] 運用マニュアル

- [ ] **監査・ログ**
  - [ ] トレード ID 鎖状トレース
  - [ ] 可視化ツール

## 実装順序の推奨

1. **Phase 1**: 基盤構築（優先度: 高）
   - プロジェクト構成
   - データベース設計
   - 基本的な moomoo 接続

2. **Phase 2**: コア機能（優先度: 高・中）
   - 戦略エンジン
   - リスク・執行
   - 基本的な UI

3. **Phase 3**: 運用機能（優先度: 中・低）
   - バックテスト
   - モニタリング
   - 通知機能

4. **Phase 4**: 拡張機能（優先度: 低）
   - 税務エクスポート
   - 高度な分析機能
   - ドキュメント整備

## 注意事項

- **Paper Trading 必須**: 全ての戦略は Paper → Live の段階的検証を強制
- **moomoo API 制約**: 購読上限、レート制限、OCO 擬似実装に注意
- **セキュリティ**: 2FA 必須、API キー暗号化、監査ログ必須
- **監視**: `/healthz` による包括的なシステム監視